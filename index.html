<script>
const BASE_URL = "https://networkrecreation.github.io/once-human-tier/";
const sheetID = "1vAozJYflA2QBeDXG_LmIo_SmHWFleFy3ZolVQsADZ8s";

const params = new URLSearchParams(location.search);
const sheetName = params.get("sheet") || "once_human"; // ← 超重要

const displayName = sheetName.replace(/_/g, " ");

document.getElementById("subtitle").textContent =
  `"${displayName}" Tier`;

const sheetImage = document.getElementById("sheetImage");
sheetImage.src = BASE_URL + "img/" + sheetName + ".png";
sheetImage.alt = displayName;

const csvUrl =
  `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:csv&sheet=${sheetName}`;

function parseCSV(text) {
  return text
    .split(/\r?\n/)
    .filter(r => r.trim())
    .map(row =>
      row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g)
        .map(c => c.replace(/"/g, "").trim())
    );
}

const tierOrder = ["S", "A", "B", "C", "D", "E", "F"];

fetch(csvUrl)
  .then(res => res.text())
  .then(text => {
    const rows = parseCSV(text);

    // ========= description =========
    if (rows[0][0] === "#description") {
      document.getElementById("description").textContent = rows[0][1] || "";
    }

    // ========= header =========
    const headers = rows[1];

    // ========= data =========
    const data = rows.slice(2).map(cols => {
      const obj = {};
      headers.forEach((h, i) => obj[h] = cols[i] || "");
      return obj;
    });

    const groups = {};
    data.forEach(item => {
      if (!groups[item.tier]) groups[item.tier] = [];
      groups[item.tier].push(item);
    });

    const container = document.getElementById("content");

    tierOrder.forEach(tier => {
      if (!groups[tier]) return;

      const section = document.createElement("div");
      section.className = "tier-section";
      section.innerHTML =
        `<div class="tier-title tier-${tier}">Tier ${tier}</div>`;

      const itemsBox = document.createElement("div");
      itemsBox.className = "tier-items";

      groups[tier].forEach(item => {
        const imgSrc = BASE_URL + "img/" + item.image;

        itemsBox.innerHTML += `
          <div class="item"
               onclick="location.href='index.html?sheet=${item.link}'">
            <img src="${imgSrc}" alt="${item.name}">
            <div class="name">${item.name}</div>
          </div>
        `;
      });

      section.appendChild(itemsBox);
      container.appendChild(section);
    });
  })
  .catch(err => console.error("CSV error:", err));
</script>
